version: "3.8"

services:
  ftp-server:
    image: stilliard/pure-ftpd
    ports:
      - "21:21"
      - "30000-30009:30000-30009" # for passive mode
    volumes:
      - /home/admin/dev/elemento-marketplace-web/ftp/data:/home/admin/
      - /home/admin/dev/elemento-marketplace-web/ftp/passwd:/etc/pure-ftpd/passwd
    # uncomment for ssl/tls, see https://github.com/stilliard/docker-pure-ftpd#tls
    #      - "/folder_on_disk/ssl:/etc/ssl/private/"
    # or ssl/tls with Let's Encrypt (cert and key as two files)
    #      - "/etc/letsencrypt/live/<your_server>/cert.pem:/etc/ssl/private/pure-ftpd-cert.pem"
    #      - "/etc/letsencrypt/live/<your_server>/privkey.pem:/etc/ssl/private/pure-ftpd-key.pem"
    networks:
      - net
    environment:
      PUBLICHOST: "localhost"
      FTP_USER_NAME: admin
      FTP_USER_PASS: change_me
      FTP_USER_HOME: /home/admin
    # also for ssl/tls:
    #      ADDED_FLAGS: "--tls=2"
    deploy:
      labels:
        - "traefik.enable=false"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    environment:
      - PMA_ARBITRARY=1
      - MYSQL_ROOT_PASSWORD=your_secure_root_password
      - PMA_HOST=mysql_db
      - PMA_PORT=3306
      - APACHE_PORT=8090
    networks:
      - net
    depends_on:
      - mysql_db
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.web.elemento.cloud`)"
        - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
        - "traefik.http.services.phpmyadmin.loadbalancer.server.port=8090"
        - "traefik.http.routers.phpmyadmin.tls=true"
        - "traefik.http.routers.phpmyadmin.tls.certresolver=leresolver"
        - "traefik.http.routers.phpmyadmin.tls.domains[0].main=phpmyadmin.web.elemento.cloud"
      replicas: 1
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == manager

  php:
    image: php:fpm-alpine
    volumes:
      - /home/admin/dev/elemento-marketplace-web/src/public:/var/www/html/
    deploy:
      labels:
        - "traefik.enable=false"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  nginx:
    image: nginx:alpine
    depends_on:
      - php
    volumes:
      - /home/admin/dev/elemento-marketplace-web/src/public:/var/www/html/
      - /home/admin/dev/elemento-marketplace-web/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.nginx.rule=Host(`nginx.web.elemento.cloud`)"
        - "traefik.http.services.nginx.loadbalancer.server.port=80"
        - "traefik.http.routers.nginx.entrypoints=websecure"
        - "traefik.http.routers.nginx.tls=true"
        - "traefik.http.routers.nginx.tls.certresolver=leresolver"
        - "traefik.http.routers.nginx.tls.domains[0].main=nginx.web.elemento.cloud"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == manager
    networks:
      - net

  mysql_db:
    image: mysql:8.0
    command: --default-authentication-plugin=caching_sha2_password
    environment:
      MYSQL_ROOT_PASSWORD: your_secure_root_password
      MYSQL_DATABASE: your_database_name
      MYSQL_USER: your_database_user
      MYSQL_PASSWORD: your_database_password
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      labels:
        - "traefik.enable=false"
      replicas: 1
      placement:
        constraints:
          - node.role == manager
    networks:
      - net

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    volumes:
      - "/home/admin/dev/elemento-marketplace-web/homepage/config:/app/config"
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.homepage.rule=Host(`homepage.web.elemento.cloud`)"
        - "traefik.http.services.homepage.loadbalancer.server.port=3000"
        - "traefik.http.routers.homepage.entrypoints=websecure"
        - "traefik.http.routers.homepage.tls=true"
        - "traefik.http.routers.homepage.tls.certresolver=leresolver"
        - "traefik.http.routers.homepage.tls.domains[0].main=homepage.web.elemento.cloud"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  crontab-ui:
    image: alseambusher/crontab-ui
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.crontab.rule=Host(`crontab.web.elemento.cloud`)"
        - "traefik.http.services.crontab.loadbalancer.server.port=8000"
        - "traefik.http.routers.crontab.entrypoints=websecure"
        - "traefik.http.routers.crontab.tls=true"
        - "traefik.http.routers.crontab.tls.certresolver=leresolver"
        - "traefik.http.routers.crontab.tls.domains[0].main=crontab.web.elemento.cloud"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.role == manager
    networks:
      - net
  
  services-discovery:
    image: nicolagutierrez/traefik-discovery:latest
    #environment:
      #HOMEPAGE_PATH: "" # if you have a custom folder (default is homepage/config/services.yaml)
      #TRAEFIK_PATH: "" # if you have a custom URL (default is http://web1.elemento.cloud:8080/api/http/routers)
    volumes:
      - "/home/admin/dev/elemento-marketplace-web/homepage/config:/app/homepage/config"
    networks:
      - net
    deploy:
      labels:
        - "traefik.enable=false"
      replicas: 1
      placement:
        max_replicas_per_node: 1

  traefik:
    image: traefik:v2.11
    environment:
      - GOOGLE_DOMAINS_ACCESS_TOKEN=YThLZFZsOGplRWdrZG15S04tc3hPZw==
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "/home/admin/dev/elemento-marketplace-web/traefik/traefik.yml:/etc/traefik/traefik.yml"
      - "/home/admin/dev/elemento-marketplace-web/traefik/acme.json:/acme.json"
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints:
          - node.role == manager
    networks:
      - net

  #  ------ MAIL SERVER -------
    # External dependencies
  redis:
    image: redis:alpine
    restart: always
    volumes:
      - "/mailu/redis:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  # Core services
  front:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}nginx:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-front
    ports:
      # - "37.27.99.151:80:80"
      # - "37.27.99.151:443:443"
      - "37.27.99.151:25:25"
      - "37.27.99.151:465:465"
      - "37.27.99.151:587:587"
      - "37.27.99.151:110:110"
      - "37.27.99.151:995:995"
      - "37.27.99.151:143:143"
      - "37.27.99.151:993:993"
    labels:
        - "traefik.enable=true"
        - "traefik.http.routers.front.rule=Host(`mail.web.elemento.cloud`)"
        # - "traefik.http.services.front.loadbalancer.server.port=80"
        # - "traefik.http.services.front.loadbalancer.server.port=443"
        # - "traefik.http.routers.front.entrypoints=websecure"
        # - "traefik.http.routers.front.tls=true"
        # - "traefik.http.routers.front.tls.certresolver=leresolver"
        # - "traefik.http.routers.front.tls.domains[0].main=mail.web.elemento.cloud"
    networks:
      - default
      - webmail
    volumes:
      - "/mailu/certs:/certs"
      - "/mailu/overrides/nginx:/overrides:ro"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  resolver:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}unbound:${MAILU_VERSION:-2.0}
    env_file: mailu.env
    restart: always
    networks:
      default:
        ipv4_address: 192.168.203.254

  admin:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}admin:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-admin
    volumes:
      - "/mailu/data:/data"
      - "/mailu/dkim:/dkim"
    depends_on:
      - redis
      - resolver
    dns:
      - 192.168.203.254

  imap:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}dovecot:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-imap
    volumes:
      - "/mailu/mail:/mail"
      - "/mailu/overrides/dovecot:/overrides:ro"
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.203.254

  smtp:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}postfix:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-smtp
    volumes:
      - "/mailu/mailqueue:/queue"
      - "/mailu/overrides/postfix:/overrides:ro"
    depends_on:
      - front
      - resolver
    dns:
      - 192.168.203.254

  oletools:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}oletools:${MAILU_VERSION:-2.0}
    hostname: oletools
    restart: always
    networks:
      - noinet
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  antispam:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}rspamd:${MAILU_VERSION:-2.0}
    hostname: antispam
    restart: always
    env_file: mailu.env
    logging:
      driver: journald
      options:
        tag: mailu-antispam
    networks:
      - default
      - noinet
    volumes:
      - "/mailu/filter:/var/lib/rspamd"
      - "/mailu/overrides/rspamd:/overrides:ro"
    depends_on:
      - front
      - redis
      - oletools
      - antivirus
      - resolver
    dns:
      - 192.168.203.254

  # Optional services
  antivirus:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}clamav:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/filter:/data"
    depends_on:
      - resolver
    dns:
      - 192.168.203.254

  # Webmail
  webmail:
    image: ${DOCKER_ORG:-ghcr.io/mailu}/${DOCKER_PREFIX:-}webmail:${MAILU_VERSION:-2.0}
    restart: always
    env_file: mailu.env
    volumes:
      - "/mailu/webmail:/data"
      - "/mailu/overrides/roundcube:/overrides:ro"
    networks:
      - webmail
    depends_on:
      - front

volumes:
  mysql_data:
  data:

networks:
  net:
    external: true
    name: "net"
  default:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 192.168.203.0/24
  webmail:
    driver: bridge
  noinet:
    driver: bridge
    internal: true
  