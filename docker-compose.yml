version: "3.8"

services:
  ftp-server:
    image: stilliard/pure-ftpd:hardened
    ports:
      - "21:21"
      - "30000-30009:30000-30009" # for passive mode
    volumes:
      - /mnt/shared_data/elemento-marketplace-web/ftp:/home/admin
    environment:
      FTP_USER_NAME: ${FTP_USER_NAME}
      FTP_USER_PASS: ${FTP_USER_PASS}
      FTP_USER_HOME: /home/admin
    deploy:
      labels:
        - "traefik.enable=false"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  phpmyadmin:
    image: phpmyadmin/phpmyadmin:latest
    environment:
      - PMA_ARBITRARY=1
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - PMA_HOST=mysql_db
      - PMA_PORT=3306
      - APACHE_PORT=8090
    depends_on:
      - mysql_db
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.web.elemento.cloud`)"
        - "traefik.http.routers.phpmyadmin.entrypoints=websecure"
        - "traefik.http.services.phpmyadmin.loadbalancer.server.port=8090"
        - "traefik.http.routers.phpmyadmin.tls=true"
        - "traefik.http.routers.phpmyadmin.tls.certresolver=leresolver"
        - "traefik.http.routers.phpmyadmin.tls.domains[0].main=phpmyadmin.web.elemento.cloud"
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  php:
    image: php:fpm-alpine
    volumes:
      - /mnt/shared_data/elemento-marketplace-web/php/src/public:/var/www/html/
    deploy:
      labels:
        - "traefik.enable=false"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  nginx:
    image: nginx:alpine
    depends_on:
      - php
    volumes:
      - /mnt/shared_data/elemento-marketplace-web/src/public:/var/www/html/
      - /mnt/shared_data/elemento-marketplace-web/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.nginx.rule=Host(`nginx.web.elemento.cloud`)"
        - "traefik.http.services.nginx.loadbalancer.server.port=80"
        - "traefik.http.routers.nginx.entrypoints=websecure"
        - "traefik.http.routers.nginx.tls=true"
        - "traefik.http.routers.nginx.tls.certresolver=leresolver"
        - "traefik.http.routers.nginx.tls.domains[0].main=nginx.web.elemento.cloud"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  mysql_db:
    image: mysql:8.0
    command: --default-authentication-plugin=caching_sha2_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - /mnt/shared_data/elemento-marketplace-web/mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      labels:
        - "traefik.enable=false"
      replicas: 1
    networks:
      - net

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    volumes:
      - "/mnt/shared_data/elemento-marketplace-web/homepage/config:/app/config"
      - "/var/run/docker.sock:/var/run/docker.sock"
    depends_on:
      - ftp-server
      - phpmyadmin
      - php
      - nginx
      - traefik
      - mysql_db
      - crontab-ui
      - services-discovery
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.homepage.rule=Host(`homepage.web.elemento.cloud`)"
        - "traefik.http.services.homepage.loadbalancer.server.port=3000"
        - "traefik.http.routers.homepage.entrypoints=websecure"
        - "traefik.http.routers.homepage.middlewares=mid-auth"
        - "traefik.http.routers.homepage.tls=true"
        - "traefik.http.routers.homepage.tls.certresolver=leresolver"
        - "traefik.http.routers.homepage.tls.domains[0].main=homepage.web.elemento.cloud"
        - "traefik.http.middlewares.mid-auth.basicauth.users=user:$$apr1$$Qwlovodu$$uwqv/FIRdGy4dT2x1fhO7/"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  crontab-ui:
    image: alseambusher/crontab-ui
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.crontab.rule=Host(`crontab.web.elemento.cloud`)"
        - "traefik.http.services.crontab.loadbalancer.server.port=8000"
        - "traefik.http.routers.crontab.entrypoints=websecure"
        - "traefik.http.routers.crontab.middlewares=mid-auth"
        - "traefik.http.routers.crontab.tls=true"
        - "traefik.http.routers.crontab.tls.certresolver=leresolver"
        - "traefik.http.routers.crontab.tls.domains[0].main=crontab.web.elemento.cloud"
        - "traefik.http.middlewares.mid-auth.basicauth.users=user:$$apr1$$Qwlovodu$$uwqv/FIRdGy4dT2x1fhO7/"
      mode: replicated
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  services-discovery:
    image: ghcr.io/nicolagutierrez/traefik-discovery:latest
    environment:
      HOMEPAGE_PATH: "homepage/config/services.yaml"
      TRAEFIK_ROUTE: "traefik:8080/api/http/routers" # docker network
    volumes:
      - "/mnt/shared_data/elemento-marketplace-web/homepage/config:/app/homepage/config"
    deploy:
      labels:
        - "traefik.enable=false"
      replicas: 1
      placement:
        max_replicas_per_node: 1
    networks:
      - net

  check-services:
    image: alpine:latest
    volumes:
      - "/mnt/shared_data/elemento-marketplace-web/check_services/check_services.sh:/usr/local/bin/check_services.sh"
    depends_on:
      - ftp-server
      - phpmyadmin
      - php
      - nginx
      - mysql_db
      - traefik
      - crontab-ui
      - services-discovery
    command: /bin/sh -c "
        apk update && apk upgrade && apk add curl && \
        if curl -X GET services-discovery:5001/api/v1/status | grep -q '{\"message\":\"Traefik discovery is running\"}'; then \
          echo 'OK'; \
        else \
          exit 1; \
        fi && \
        curl -X POST services-discovery:5001/api/v1/homepage/refresh"
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - net

  traefik:
    image: traefik:v2.11
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    volumes:
      - "/mnt/shared_data/elemento-marketplace-web/traefik/traefik.yml:/etc/traefik/traefik.yml"
      - "/mnt/shared_data/elemento-marketplace-web/traefik/acme.json:/acme.json"
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - net

networks:
  net:
    external: true
    name: "net"
